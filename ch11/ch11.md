# 11장: 자동화 테스트 작성하기

## 1. 테스트의 필요성

* 테스트는 버그의 **존재를 보여주는 데 효과적**이지만, **버그의 부재를 증명할 수는 없음** (에츠허르 다익스트라 인용).
* Rust의 타입 시스템이 많은 오류를 방지하지만, **논리적 오류는 잡아내지 못함**.
* 코드가 변경될 때마다 자동화된 테스트를 실행하여 **의도된 동작이 유지되는지 검증**할 수 있음.

---

## 2. 테스트 작성 방법

Rust에서 테스트는 `#[test]` 어노테이션을 붙인 함수로 작성합니다.

### 기본 구조

```rust
#[test]
fn it_works() {
    assert_eq!(2 + 2, 4);
}
```

* `#[test]` → 테스트 함수임을 표시
* 실행: `cargo test`

### 단언 매크로

* `assert!` : 조건이 `true`인지 확인
* `assert_eq!(a, b)` : 값이 같은지 검사
* `assert_ne!(a, b)` : 값이 다른지 검사
* 실패 시 디버그 메시지 출력

### 커스텀 메시지

```rust
assert!(result.contains(name), "Greeting did not contain name, value was `{}`", result);
```

* 실패 시 메시지에 추가 정보 포함 가능

### 패닉 검사

```rust
#[test]
#[should_panic(expected = "less than or equal to 100")]
fn greater_than_100() {
    Guess::new(200);
}
```

* `#[should_panic]` : 함수 실행 중 패닉이 발생해야 통과
* `expected` 매개변수로 특정 에러 메시지를 검사 가능

### `Result<T, E>` 반환 테스트

```rust
#[test]
fn it_works() -> Result<(), String> {
    if 2 + 2 == 4 {
        Ok(())
    } else {
        Err(String::from("2 + 2 != 4"))
    }
}
```

* 실패 시 `Err` 반환 가능
* `?` 연산자 사용 가능 (단, `#[should_panic]`와는 함께 사용 불가)

---

## 3. 테스트 실행 방법 제어

기본적으로 `cargo test`는:

* 모든 테스트를 **병렬 실행**
* **출력을 캡처**하여 실패 시에만 표시

### 옵션

* **병렬 실행 제어**

  ```bash
  cargo test -- --test-threads=1
  ```

  → 순차 실행

* **출력 표시**

  ```bash
  cargo test -- --show-output
  ```

* **특정 테스트만 실행**

  ```bash
  cargo test test_name
  cargo test add   # 이름에 "add" 포함된 테스트 실행
  ```

* **무시된 테스트 실행**

  ```rust
  #[test]
  #[ignore]
  fn expensive_test() { ... }
  ```

  ```bash
  cargo test -- --ignored
  ```

---

## 4. 테스트 조직화

### 유닛 테스트 (Unit Test)

* **목적**: 개별 모듈/함수가 올바르게 동작하는지 빠르게 확인
* 위치: 보통 `src` 파일 안, `#[cfg(test)]` 모듈 내
* 비공개 함수 테스트도 허용 (`use super::*;`)

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn internal_test() {
        assert_eq!(internal_adder(2, 2), 4);
    }
}
```

### 통합 테스트 (Integration Test)

* **목적**: 라이브러리의 여러 부분이 함께 잘 동작하는지 확인
* 위치: 프로젝트 루트의 `tests/` 디렉터리
* 특징:

    * 각 파일은 별도의 크레이트로 취급됨
    * `use my_crate;` 형태로 공개 API만 접근 가능
    * `#[cfg(test)]` 불필요
* 공통 코드 공유는 `tests/common/mod.rs` 활용

---

## 핵심 요약

* Rust는 `#[test]` 속성과 매크로(`assert!`, `assert_eq!`, `assert_ne!`)를 사용해 자동화 테스트를 지원.
* `#[should_panic]`와 `Result<T, E>` 기반 테스트로 다양한 시나리오 검증 가능.
* `cargo test` 옵션으로 **병렬 실행 제어**, **출력 확인**, **특정 테스트 실행/무시** 가능.
* 테스트 구조:

    * **유닛 테스트**: `src/` 내부, 개별 함수/모듈 검증, 비공개 함수도 가능.
    * **통합 테스트**: `tests/` 디렉터리, 공개 API 기준, 실제 사용자 시나리오 검증.
