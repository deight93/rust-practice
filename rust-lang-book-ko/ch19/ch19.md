# 19장: 고급 기능

이 장에서는 러스트의 **잘 쓰이지 않지만 알아두면 강력한 기능들**을 다룹니다.
안전하지 않은 코드, 고급 트레이트, 타입, 함수/클로저, 매크로가 포함됩니다.

---

## 1. 안전하지 않은 러스트 (Unsafe Rust)

Rust는 기본적으로 메모리 안전을 보장하지만,
`unsafe` 키워드를 통해 컴파일러 검사를 우회할 수 있습니다.

### `unsafe`에서 가능한 5가지

1. **원시 포인터 역참조** (`*const T`, `*mut T`)
2. **안전하지 않은 함수/메서드 호출**
3. **가변 정적 변수 접근 및 수정**
4. **안전하지 않은 트레이트 구현**
5. **union 필드 접근**

→ 반드시 필요한 경우만 사용하며, 보통은 안전한 **추상화**로 감싸 사용합니다.

---

## 2. 고급 트레이트

### 연관 타입 (Associated Types)

* 트레이트 정의 안에 자리표시자 타입 지정 가능.
* 예: `Iterator`의 `type Item`.

### 기본 제네릭 타입 매개변수

* `trait Add<Rhs=Self>`처럼 기본 타입 설정 가능.
* 연산자 오버로딩(`+`) 등에 사용.

### 완전 정규화 문법 (Fully Qualified Syntax)

* 동일 이름 메서드/연관 함수 충돌 시 명시적 지정 필요.

  ```rust
  <Type as Trait>::method(&instance)
  ```

### 슈퍼트레이트 (Supertrait)

* 다른 트레이트를 상속받는 트레이트.
* 예: `trait OutlinePrint: Display`.

### 뉴타입 패턴 (Newtype Pattern)

* 기존 타입을 새 구조체로 감싸 외부 트레이트 구현 가능.

---

## 3. 고급 타입

### 뉴타입 패턴

* 타입 안정성 확보 (예: `Millimeters(u32)` vs `Meters(u32)`).

### 타입 별칭 (Type Alias)

* 반복 줄이기.

  ```rust
  type Thunk = Box<dyn Fn() + Send + 'static>;
  ```

### 부정 타입 (Never Type) `!`

* 값이 존재하지 않음을 의미.
* 예: `panic!`, `continue`, `loop` 등.

### 동적 크기 타입 (Dynamically Sized Types, DST)

* `str`, 트레이트 객체(`dyn Trait`) 등이 해당.
* 보통 `&str`, `Box<dyn Trait>` 형태로 사용.

---

## 4. 고급 함수와 클로저

### 함수 포인터 (`fn`)

* 함수 자체를 인자로 넘기거나 반환 가능.
* `fn`은 클로저 트레이트(`Fn`, `FnMut`, `FnOnce`) 모두 구현.

### 클로저 반환

* 클로저 타입은 알 수 없으므로 직접 반환 불가.
* 해결: `Box<dyn Fn()>` 같은 트레이트 객체로 감싸 반환.

---

## 5. 매크로

Rust의 매크로는 **코드를 생성하는 코드** (메타프로그래밍)입니다.

### 매크로 vs 함수

* 매크로는 가변 인자 가능, 컴파일 타임에 코드 생성.
* 함수는 런타임 실행.

### 선언적 매크로 (`macro_rules!`)

* `vec!` 같은 매크로.
* `match` 문법과 유사하게 패턴 매칭 후 코드 확장.

### 절차적 매크로

* 입력 `TokenStream` → 출력 `TokenStream`.
* 종류:

    1. **커스텀 파생 (derive)**: `#[derive(Custom)]`
    2. **속성형 (attribute-like)**: `#[route(GET, "/")]`
    3. **함수형 (function-like)**: `sql!(SELECT * FROM ...)`

---

## 핵심 요약

* **Unsafe Rust**: 포인터, FFI 등 저수준 제어 가능. 신중히 사용.
* **고급 트레이트**: 연관 타입, 기본 제네릭, 완전 정규화 문법, 슈퍼트레이트, 뉴타입 패턴.
* **고급 타입**: 뉴타입, 타입 별칭, 부정 타입(`!`), DST.
* **고급 함수/클로저**: 함수 포인터(`fn`), 클로저 반환(`Box<dyn Fn>`).
* **매크로**: `macro_rules!`(선언적), 절차적 매크로(`derive`, 속성형, 함수형).
